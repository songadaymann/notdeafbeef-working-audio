#include "particles.h"
#include "raster.h"
#include <stdlib.h>
#include <math.h>
#include <string.h>

/* Simple 5x7 bitmap font for ASCII glyphs */
static const uint8_t FONT_5X7[][7] = {
    /* A */ {0x0E,0x11,0x11,0x1F,0x11,0x11,0x11},
    /* B */ {0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E},
    /* C */ {0x0E,0x11,0x10,0x10,0x10,0x11,0x0E},
    /* D */ {0x1E,0x11,0x11,0x11,0x11,0x11,0x1E},
    /* E */ {0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F},
    /* F */ {0x1F,0x10,0x10,0x1E,0x10,0x10,0x10},
    /* G */ {0x0E,0x11,0x10,0x17,0x11,0x11,0x0E},
    /* H */ {0x11,0x11,0x11,0x1F,0x11,0x11,0x11},
    /* I */ {0x0E,0x04,0x04,0x04,0x04,0x04,0x0E},
    /* J */ {0x07,0x02,0x02,0x02,0x02,0x12,0x0C},
    /* K */ {0x11,0x12,0x14,0x18,0x14,0x12,0x11},
    /* L */ {0x10,0x10,0x10,0x10,0x10,0x10,0x1F},
    /* M */ {0x11,0x1B,0x15,0x15,0x11,0x11,0x11},
    /* N */ {0x11,0x19,0x15,0x13,0x11,0x11,0x11},
    /* O */ {0x0E,0x11,0x11,0x11,0x11,0x11,0x0E},
    /* P */ {0x1E,0x11,0x11,0x1E,0x10,0x10,0x10},
    /* Q */ {0x0E,0x11,0x11,0x11,0x15,0x12,0x0D},
    /* R */ {0x1E,0x11,0x11,0x1E,0x14,0x12,0x11},
    /* S */ {0x0E,0x11,0x10,0x0E,0x01,0x11,0x0E},
    /* T */ {0x1F,0x04,0x04,0x04,0x04,0x04,0x04},
    /* U */ {0x11,0x11,0x11,0x11,0x11,0x11,0x0E},
    /* V */ {0x11,0x11,0x11,0x11,0x11,0x0A,0x04},
    /* W */ {0x11,0x11,0x11,0x15,0x15,0x1B,0x11},
    /* X */ {0x11,0x11,0x0A,0x04,0x0A,0x11,0x11},
    /* Y */ {0x11,0x11,0x0A,0x04,0x04,0x04,0x04},
    /* Z */ {0x1F,0x01,0x02,0x04,0x08,0x10,0x1F},
    /* 0 */ {0x0E,0x11,0x13,0x15,0x19,0x11,0x0E},
    /* 1 */ {0x04,0x0C,0x04,0x04,0x04,0x04,0x0E},
    /* 2 */ {0x0E,0x11,0x01,0x02,0x04,0x08,0x1F},
    /* 3 */ {0x0E,0x11,0x01,0x06,0x01,0x11,0x0E},
    /* 4 */ {0x02,0x06,0x0A,0x12,0x1F,0x02,0x02},
    /* 5 */ {0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E},
    /* 6 */ {0x06,0x08,0x10,0x1E,0x11,0x11,0x0E},
    /* 7 */ {0x1F,0x01,0x02,0x04,0x08,0x08,0x08},
    /* 8 */ {0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E},
    /* 9 */ {0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C},
    /* ! */ {0x04,0x04,0x04,0x04,0x04,0x00,0x04},
    /* @ */ {0x0E,0x11,0x17,0x15,0x17,0x10,0x0E},
    /* # */ {0x0A,0x0A,0x1F,0x0A,0x1F,0x0A,0x0A},
    /* $ */ {0x04,0x0F,0x14,0x0E,0x05,0x1E,0x04},
    /* % */ {0x18,0x19,0x02,0x04,0x08,0x13,0x03},
    /* ^ */ {0x04,0x0A,0x11,0x00,0x00,0x00,0x00},
    /* & */ {0x0C,0x12,0x14,0x08,0x15,0x12,0x0D},
    /* * */ {0x00,0x04,0x15,0x0E,0x15,0x04,0x00},
    /* + */ {0x00,0x04,0x04,0x1F,0x04,0x04,0x00},
    /* - */ {0x00,0x00,0x00,0x1F,0x00,0x00,0x00},
    /* = */ {0x00,0x00,0x1F,0x00,0x1F,0x00,0x00},
    /* ? */ {0x0E,0x11,0x01,0x02,0x04,0x00,0x04}
};

static const char GLYPH_SET[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*+-=?";

static void draw_glyph(uint32_t *fb,int w,int h,int x,int y,uint8_t glyph_idx,uint32_t color)
{
    if(glyph_idx >= sizeof(FONT_5X7)/sizeof(FONT_5X7[0])) return;
    const uint8_t *bitmap = FONT_5X7[glyph_idx];
    for(int row=0;row<7;row++){
        uint8_t bits = bitmap[row];
        for(int col=0;col<5;col++){
            if(bits & (1<<(4-col))){
                int px = x + col;
                int py = y + row;
                if((unsigned)px < (unsigned)w && (unsigned)py < (unsigned)h){
                    fb[py*w + px] = color;
                }
            }
        }
    }
}

static particle_t g_particles[MAX_PARTICLES];
static int g_count=0;

void particles_init(void){ g_count=0; }

void particles_spawn_burst(float x,float y,int count,uint32_t color)
{
    if(count<1) return;
    if(count>MAX_PARTICLES) count = MAX_PARTICLES;
    float angle_step = 2.0f * (float)M_PI / (float)count;
    for(int i=0;i<count;i++){
        if(g_count>=MAX_PARTICLES) break;
        float ang = i * angle_step;
        particle_t *p = &g_particles[g_count++];
        p->x = x; p->y=y;
        float speed = 2.0f + (rand()%100)/50.0f; /* 2â€“4 */
        p->vx = cosf(ang)*speed;
        p->vy = sinf(ang)*speed;
        p->life = 30 + (rand()%2)*30 + (rand()%2)*30; /* 30,60,90 */
        p->max_life = p->life;
        p->color = color;
        p->glyph = (uint8_t)(rand() % strlen(GLYPH_SET));
    }
}

void particles_update_and_draw(uint32_t *fb,int w,int h)
{
    for(int i=0;i<g_count;){
        particle_t *p = &g_particles[i];
        /* update */
        p->x += p->vx;
        p->y += p->vy;
        p->vy += 0.1f; /* gravity */
        p->life--;
        if(p->life<=0 || p->x<0 || p->x>=w || p->y>=h){
            /* remove by swap with last */
            g_particles[i] = g_particles[--g_count];
            continue;
        }
        /* fade alpha based on life */
        float alpha = (float)p->life / (float)p->max_life;
        uint32_t r = (p->color >> 24) & 0xFF;
        uint32_t g = (p->color >> 16) & 0xFF;
        uint32_t b = (p->color >> 8) & 0xFF;
        r = (uint32_t)(r * alpha);
        g = (uint32_t)(g * alpha);
        b = (uint32_t)(b * alpha);
        uint32_t faded_color = (r<<24)|(g<<16)|(b<<8)|0xFF;
        
        /* draw glyph */
        draw_glyph(fb,w,h,(int)p->x-2,(int)p->y-3,p->glyph,faded_color);
        ++i;
    }
} 